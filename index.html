<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>An Extension of Tidymodels Supporting Offset Terms • offsetreg</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="An Extension of Tidymodels Supporting Offset Terms">
<meta name="description" content="Extend the tidymodels ecosystem &lt;https://www.tidymodels.org/&gt; to enable the creation of predictive models with offset terms. Models with offsets are most useful when working with count data or when fitting an adjustment model on top of an existing model with a prior expectation. The former situation is common in insurance where data is often weighted by exposures. The latter is common in life insurance where industry mortality tables are often used as a starting point for setting assumptions.">
<meta property="og:description" content="Extend the tidymodels ecosystem &lt;https://www.tidymodels.org/&gt; to enable the creation of predictive models with offset terms. Models with offsets are most useful when working with count data or when fitting an adjustment model on top of an existing model with a prior expectation. The former situation is common in insurance where data is often weighted by exposures. The latter is common in life insurance where industry mortality tables are often used as a starting point for setting assumptions.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">offsetreg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/usage.html">When to use offsetreg</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mattheaphy/offsetreg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="offsetreg">offsetreg<a class="anchor" aria-label="anchor" href="#offsetreg"></a>
</h1></div>
<!-- badges: start -->

<p>This package extends the <a href="https://www.tidymodels.org" class="external-link">tidymodels</a> ecosystem to enable usage of predictive models with offset terms. Offset terms are predictors in a linear model that with a known <em>a priori</em> value. In other words, these terms do not have an associated coefficient (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\beta_i</annotation></semantics></math>) that needs to be determined. In a generalized linear model (GLM), an offset specification looks like:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>Y</mi><mo accent="true">̂</mo></mover><mo>=</mo><msup><mi>g</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>o</mi><mi>f</mi><mi>f</mi><mi>s</mi><mi>e</mi><mi>t</mi><mo>+</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><msub><mi>X</mi><mn>1</mn></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><msub><mi>X</mi><mn>2</mn></msub><mo>+</mo><mi>…</mi><mo>+</mo><msub><mi>β</mi><mi>p</mi></msub><msub><mi>X</mi><mi>p</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\hat{Y} = g^{-1}(offset + \beta_0 + \beta_1X_1 + \beta_2X_2 + \ldots + \beta_pX_p)
</annotation></semantics></math></p>
<p>Models with offsets are most useful when working with count data or when fitting an adjustment model on top of an existing model with a prior expectation. The former situation is common in insurance where data is often aggregated or weighted by exposures. The latter is common in life insurance where industry mortality tables are often used as a starting point for setting assumptions on a particular block of business.</p>
<p>In general, offsetreg functions are named after existing functions from tidymodels or other modeling packages suffixed by <code>_offset</code> (or <code>_exposure</code>). The modeling engines in this package are wrappers around existing, well-known modeling functions. These engines all include the argument <code>offset_col</code> (or <code>exposure_col</code>) which is used to specify which column in the data passed to the engine contains offsets.</p>
<p>Currently, the following model specifications and engines are available:</p>
<ul>
<li>
<p><code><a href="reference/poisson_reg_offset.html">poisson_reg_offset()</a></code> - create a Poisson GLM spec. Engines:</p>
<ul>
<li>
<code>glm_offset</code> - a wrapper around <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm()</a></code>
</li>
<li>
<code>glmnet_offset</code> - a wrapper around <code><a href="https://rdrr.io/pkg/glmnet/man/glmnet.html" class="external-link">glmnet::glmnet()</a></code>
</li>
</ul>
</li>
<li>
<p><code><a href="reference/boost_tree_offset.html">boost_tree_offset()</a></code> - create an ensemble of boosted Poisson decision trees. Engines:</p>
<ul>
<li>
<code>xgboost_offset</code> - a wrapper around <code><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgboost::xgb.train()</a></code>
</li>
</ul>
</li>
<li>
<p><code><a href="reference/decision_tree_exposure.html">decision_tree_exposure()</a></code> - create a Poisson decision tree with weighted exposures. Engines:</p>
<ul>
<li>
<code>rpart_exposure</code> - a wrapper around <code><a href="https://rdrr.io/pkg/rpart/man/rpart.html" class="external-link">rpart::rpart()</a></code>
</li>
</ul>
</li>
</ul>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The offsetreg package can be installed from CRAN with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"offsetreg"</span><span class="op">)</span></span></code></pre></div>
<p>You can install the development version of offsetreg from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"mattheaphy/offsetreg"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<p>The <code>us_deaths</code> data set contains United States deaths, population estimates, and crude mortality rates for ages 25+ from the CDC Multiple Causes of Death Files for the years 2011-2020.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mattheaphy/offsetreg/" class="external-link">offsetreg</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_deaths</span></span>
<span><span class="co">#&gt; # A tibble: 140 × 6</span></span>
<span><span class="co">#&gt;    gender age_group  year deaths population       qx</span></span>
<span><span class="co">#&gt;    &lt;fct&gt;  &lt;fct&gt;     &lt;int&gt;  &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 Female 25-34      2011  13663   20746335 0.000659</span></span>
<span><span class="co">#&gt;  2 Female 25-34      2012  13808   20970529 0.000658</span></span>
<span><span class="co">#&gt;  3 Female 25-34      2013  14001   21203096 0.000660</span></span>
<span><span class="co">#&gt;  4 Female 25-34      2014  14480   21546290 0.000672</span></span>
<span><span class="co">#&gt;  5 Female 25-34      2015  15736   21838064 0.000721</span></span>
<span><span class="co">#&gt;  6 Female 25-34      2016  17359   22077505 0.000786</span></span>
<span><span class="co">#&gt;  7 Female 25-34      2017  18066   22351311 0.000808</span></span>
<span><span class="co">#&gt;  8 Female 25-34      2018  17980   22487065 0.000800</span></span>
<span><span class="co">#&gt;  9 Female 25-34      2019  17827   22581141 0.000789</span></span>
<span><span class="co">#&gt; 10 Female 25-34      2020  21654   22625267 0.000957</span></span>
<span><span class="co">#&gt; # ℹ 130 more rows</span></span></code></pre></div>
<p>Assume we want to create a poisson model for the number of deaths. First, an offset term is created by taking the natural log of population, which is our exposure basis. A natural log is used because the link function in poisson regression is the exponential function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">us_deaths</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">us_deaths</span><span class="op">$</span><span class="va">population</span><span class="op">)</span></span></code></pre></div>
<p>Create a poisson regression model with an offset, and set the engine to “glm_offset”. The engine-specific argument <code>offset_col</code> must refer to the name of the column in <code>us_deaths</code> that contains offsets.</p>
<p><strong>Note</strong>: The offset term should always be included in model formulas.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glm_off</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/poisson_reg_offset.html">poisson_reg_offset</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># set the modeling engine and specify the offset column</span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"glm_offset"</span>, offset_col <span class="op">=</span> <span class="st">"offset"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># always include the offset term in the model formula</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">offset</span>, data <span class="op">=</span> <span class="va">us_deaths</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_off</span></span>
<span><span class="co">#&gt; parsnip model object</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:  stats::glm(formula = formula, family = family, data = data, weights = weights, </span></span>
<span><span class="co">#&gt;     offset = offset)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;    (Intercept)      genderMale  age_group35-44  age_group45-54  age_group55-64  </span></span>
<span><span class="co">#&gt;     -18.337940        0.327632        0.442935        1.212463        1.990698  </span></span>
<span><span class="co">#&gt; age_group65-74  age_group75-84    age_group85+            year  </span></span>
<span><span class="co">#&gt;       2.713410        3.645763        4.770408        0.005683  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Degrees of Freedom: 139 Total (i.e. Null);  131 Residual</span></span>
<span><span class="co">#&gt; Null Deviance:       51700000 </span></span>
<span><span class="co">#&gt; Residual Deviance: 237800    AIC: 239800</span></span></code></pre></div>
<p>Verify that coefficients match <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glm_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="va">year</span>, offset <span class="op">=</span> <span class="va">offset</span>,</span>
<span>                data <span class="op">=</span> <span class="va">us_deaths</span>, family <span class="op">=</span> <span class="st">'poisson'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_fit_engine</a></span><span class="op">(</span><span class="va">glm_off</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">glm_base</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=offsetreg" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/mattheaphy/offsetreg/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/mattheaphy/offsetreg/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing offsetreg</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Matt Heaphy <br><small class="roles"> Author, maintainer, copyright holder </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://CRAN.R-project.org/package=offsetreg" class="external-link"><img src="https://www.r-pkg.org/badges/version/offsetreg" alt="CRAN status"></a></li>
<li><a href="https://github.com/mattheaphy/offsetreg/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/mattheaphy/offsetreg/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matt Heaphy.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
