<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>When to use offsetreg • offsetreg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="When to use offsetreg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">offsetreg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/usage.html">When to use offsetreg</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mattheaphy/offsetreg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>When to use offsetreg</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mattheaphy/offsetreg/blob/main/vignettes/usage.Rmd" class="external-link"><code>vignettes/usage.Rmd</code></a></small>
      <div class="d-none name"><code>usage.Rmd</code></div>
    </div>

    
    
<p>This vignette describes the motivation for offsetreg and when its
usage becomes necessary.</p>
<div class="section level2">
<h2 id="when-offsetreg-is-not-necessary">When offsetreg is not necessary<a class="anchor" aria-label="anchor" href="#when-offsetreg-is-not-necessary"></a>
</h2>
<p>For certain use cases, offsets are supported in tidymodels. Generally
speaking, for models that allow for offsets to be specified in a model
formula, tidymodels works fine out of the box and offsetreg is not
needed. The <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> function from the stats package is a good
example of this.</p>
<div class="section level3">
<h3 id="offsets-supported-in-model-formulas-glm">Offsets supported in model formulas: <code>glm()</code><a class="anchor" aria-label="anchor" href="#offsets-supported-in-model-formulas-glm"></a>
</h3>
<p>Below, a Poisson model is fit using the <code>us_deaths</code> data
set with an offset equal to the log of population.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mattheaphy/offsetreg/" class="external-link">offsetreg</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org" class="external-link">rsample</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tune.tidymodels.org/" class="external-link">tune</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_deaths</span><span class="op">$</span><span class="va">log_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">us_deaths</span><span class="op">$</span><span class="va">population</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html" class="external-link">poisson_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"glm"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">log_pop</span><span class="op">)</span>, </span>
<span>      data <span class="op">=</span> <span class="va">us_deaths</span><span class="op">)</span></span>
<span><span class="co">#&gt; parsnip model object</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:  stats::glm(formula = deaths ~ gender + age_group + year + offset(log_pop), </span></span>
<span><span class="co">#&gt;     family = stats::poisson, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;    (Intercept)      genderMale  age_group35-44  age_group45-54  age_group55-64  </span></span>
<span><span class="co">#&gt;     -18.337940        0.327632        0.442935        1.212463        1.990698  </span></span>
<span><span class="co">#&gt; age_group65-74  age_group75-84    age_group85+            year  </span></span>
<span><span class="co">#&gt;       2.713410        3.645763        4.770408        0.005683  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Degrees of Freedom: 139 Total (i.e. Null);  131 Residual</span></span>
<span><span class="co">#&gt; Null Deviance:       51700000 </span></span>
<span><span class="co">#&gt; Residual Deviance: 237800    AIC: 239800</span></span></code></pre></div>
<p>The code above works for a few reasons:</p>
<ul>
<li>
<code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code> captures the formula expression passed to it, and
that formula is allowed to contain calls to other functions, like
<code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code>.</li>
<li>Since there is no additional pre-processing of the data required,
that formula is passed to the <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> function as-is, as
shown in the call printed above.</li>
</ul>
<p>Let’s assume we want to use a recipe to pre-process our data. In the
example below, a bare bones recipe is used to verify that we can
reproduce the same coefficients as the original example. Unfortunately,
this creates a problem because <code><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe()</a></code> doesn’t allow
in-line functions like <code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html" class="external-link">poisson_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"glm"</span><span class="op">)</span></span>
<span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">log_pop</span><span class="op">)</span>, </span>
<span>              data <span class="op">=</span> <span class="va">us_deaths</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `recipe()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Misspelled variable name or in-line functions detected.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The following function/misspelling was found: `offset`.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use steps to do transformations instead.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If your modeling engine uses special terms in formulas, pass that formula to</span></span>
<span><span class="co">#&gt;   workflows as a model formula (`?parsnip::model_formula()`).</span></span></code></pre></div>
<p>As the hint above explains, this error can be avoided by removing the
call to <code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code> in the recipe and passing a second formula
to <code><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model()</a></code> as part of a workflow. Note that the
variable passed to <code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code> must still be included in the
recipe.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">log_pop</span>, </span>
<span>              data <span class="op">=</span> <span class="va">us_deaths</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model</a></span><span class="op">(</span><span class="va">mod</span>, </span>
<span>            formula <span class="op">=</span> <span class="va">deaths</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">log_pop</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_recipe.html" class="external-link">add_recipe</a></span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">us_deaths</span><span class="op">)</span></span>
<span><span class="co">#&gt; ══ Workflow [trained] ══════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Preprocessor:</span> Recipe</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Model:</span> poisson_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; 0 Recipe Steps</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ───────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:  stats::glm(formula = deaths ~ gender + age_group + year + offset(log_pop), </span></span>
<span><span class="co">#&gt;     family = stats::poisson, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;    (Intercept)      genderMale  age_group35-44  age_group45-54  age_group55-64  </span></span>
<span><span class="co">#&gt;     -18.337940        0.327632        0.442935        1.212463        1.990698  </span></span>
<span><span class="co">#&gt; age_group65-74  age_group75-84    age_group85+            year  </span></span>
<span><span class="co">#&gt;       2.713410        3.645763        4.770408        0.005683  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Degrees of Freedom: 139 Total (i.e. Null);  131 Residual</span></span>
<span><span class="co">#&gt; Null Deviance:       51700000 </span></span>
<span><span class="co">#&gt; Residual Deviance: 237800    AIC: 239800</span></span></code></pre></div>
<p>These coefficients match the first example without a recipe, so we
know this model was set up correctly.</p>
</div>
<div class="section level3">
<h3 id="offsets-not-supported-in-model-formulas-glmnet">Offsets not supported in model formulas: <code>glmnet()</code><a class="anchor" aria-label="anchor" href="#offsets-not-supported-in-model-formulas-glmnet"></a>
</h3>
<p>Not all modeling engines allow for offsets to be passed via the
formula interface. For example, the <code>glmnet()</code> function does
not not accept formulas; it requires model matrices. Instead, offsets
are passed as a numeric vector using an optional engine-specific
<code>offset</code> argument.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html" class="external-link">poisson_reg</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">1E-5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"glmnet"</span>, offset <span class="op">=</span> <span class="va">us_deaths</span><span class="op">$</span><span class="va">log_pop</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span>, </span>
<span>      data <span class="op">=</span> <span class="va">us_deaths</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loaded glmnet 4.1-8</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 3</span></span></span>
<span><span class="co">#&gt;   term            estimate penalty</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)    -<span style="color: #BB0000;">17.7</span>     0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> year             0.005<span style="text-decoration: underline;">40</span> 0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> genderMale       0.326   0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> age_group35-44   0.338   0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> age_group45-54   1.11    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> age_group55-64   1.89    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> age_group65-74   2.62    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> age_group75-84   3.55    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> age_group85+     4.68    0.000<span style="text-decoration: underline;">01</span></span></span></code></pre></div>
<p>This code works because the argument
<code>offset = us_deaths$log_pop</code> is captured and passed directly
into <code>glmnet()</code>.</p>
<p>If we try to use a recipe with an offset passed to the
<code>formula</code> argument of <code><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model()</a></code>, a
difficult-to-spot problem emerges. The model runs without errors, but a
completely different set of coefficients is returned.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_glmnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html" class="external-link">poisson_reg</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">1E-5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"glmnet"</span><span class="op">)</span></span>
<span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="va">log_pop</span>, </span>
<span>              data <span class="op">=</span> <span class="va">us_deaths</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model</a></span><span class="op">(</span><span class="va">mod_glmnet</span>, </span>
<span>            formula <span class="op">=</span> <span class="va">deaths</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">log_pop</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_recipe.html" class="external-link">add_recipe</a></span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">us_deaths</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 3</span></span></span>
<span><span class="co">#&gt;   term           estimate penalty</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)    -<span style="color: #BB0000;">42.9</span>    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> year             0.026<span style="text-decoration: underline;">3</span> 0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> genderMale       0.024<span style="text-decoration: underline;">3</span> 0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> age_group35-44   0.303  0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> age_group45-54   1.12   0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> age_group55-64   1.85   0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> age_group65-74   2.19   0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> age_group75-84   2.45   0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> age_group85+     2.71   0.000<span style="text-decoration: underline;">01</span></span></span></code></pre></div>
<p>What happened here? Since <code>glmnet()</code> doesn’t natively
support the formula interface, it doesn’t know what to do with the
<code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code> term passed to the formula. Under the hood, the
<code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code> term is quietly dropped in a call to
<code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code> that is used to convert the formula to a
matrix format acceptable to <code>glmnet()</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">log_pop</span><span class="op">)</span>,</span>
<span>             <span class="va">us_deaths</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   (Intercept) year genderMale age_group35-44 age_group45-54 age_group55-64</span></span>
<span><span class="co">#&gt; 1           1 2011          0              0              0              0</span></span>
<span><span class="co">#&gt; 2           1 2012          0              0              0              0</span></span>
<span><span class="co">#&gt; 3           1 2013          0              0              0              0</span></span>
<span><span class="co">#&gt; 4           1 2014          0              0              0              0</span></span>
<span><span class="co">#&gt; 5           1 2015          0              0              0              0</span></span>
<span><span class="co">#&gt; 6           1 2016          0              0              0              0</span></span>
<span><span class="co">#&gt;   age_group65-74 age_group75-84 age_group85+</span></span>
<span><span class="co">#&gt; 1              0              0            0</span></span>
<span><span class="co">#&gt; 2              0              0            0</span></span>
<span><span class="co">#&gt; 3              0              0            0</span></span>
<span><span class="co">#&gt; 4              0              0            0</span></span>
<span><span class="co">#&gt; 5              0              0            0</span></span>
<span><span class="co">#&gt; 6              0              0            0</span></span></code></pre></div>
<p>As a result, the model is exactly what we would see if there were no
offset terms to begin with. This is a situation when offsetreg is
required.</p>
</div>
</div>
<div class="section level2">
<h2 id="when-offsetreg-is-necessary">When offsetreg is necessary<a class="anchor" aria-label="anchor" href="#when-offsetreg-is-necessary"></a>
</h2>
<p>offsetreg becomes necessary when the underlying modeling engine does
not support offsets in formulas <strong>and</strong> either of these
tasks are performed:</p>
<ul>
<li>A pre-processing recipe is applied to the data</li>
<li>Resampling is performed, often in conjunction with hyperparameter
tuning</li>
</ul>
<div class="section level3">
<h3 id="using-recipe-when-offsets-cannot-be-specified-in-a-formula">Using <code>recipe()</code> when offsets cannot be specified in a
formula<a class="anchor" aria-label="anchor" href="#using-recipe-when-offsets-cannot-be-specified-in-a-formula"></a>
</h3>
<p>Let’s continue with the last example. The problem can be addressed
using offsetreg as follows:</p>
<ul>
<li>Replace <code><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html" class="external-link">poisson_reg()</a></code> with
<code><a href="../reference/poisson_reg_offset.html">poisson_reg_offset()</a></code>
</li>
<li>Replace the “glmnet” engine with “glmnet_offset” and provide the
name of the offset column</li>
<li>Remove the <code>formula</code> argument in
<code><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model()</a></code>
</li>
<li>Add a call to <code><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy()</a></code>. This step was previously
not necessary when <code>formula</code> was passed to
<code><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model()</a></code>.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_offset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poisson_reg_offset.html">poisson_reg_offset</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">1E-5</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"glmnet_offset"</span>, offset_col <span class="op">=</span> <span class="st">"log_pop"</span><span class="op">)</span></span>
<span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="va">log_pop</span>, </span>
<span>              data <span class="op">=</span> <span class="va">us_deaths</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_nominal_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model</a></span><span class="op">(</span><span class="va">mod_offset</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_recipe.html" class="external-link">add_recipe</a></span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">us_deaths</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 3</span></span></span>
<span><span class="co">#&gt;   term              estimate penalty</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)      -<span style="color: #BB0000;">17.7</span>     0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> year               0.005<span style="text-decoration: underline;">40</span> 0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> gender_Male        0.326   0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> age_group_X35.44   0.338   0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> age_group_X45.54   1.11    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> age_group_X55.64   1.89    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> age_group_X65.74   2.62    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> age_group_X75.84   3.55    0.000<span style="text-decoration: underline;">01</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> age_group_X85.     4.68    0.000<span style="text-decoration: underline;">01</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="resampling-when-offsets-cannot-be-specified-in-a-formula">Resampling when offsets cannot be specified in a formula<a class="anchor" aria-label="anchor" href="#resampling-when-offsets-cannot-be-specified-in-a-formula"></a>
</h3>
<p>For models like <code>glmnet()</code> where offsets can only be
specified as a numeric vector in engine-specific arguments, resampling
presents a few challenges:</p>
<ul>
<li>tidymodels is only aware of the numeric vector of offsets that has
been passed and there is no defined relationship between individual
observations and their associated offsets. As a result, when resampling
occurs, offsets aren’t carried over to resampled data sets.</li>
<li>Related, and pertinent to <code>glmnet()</code>, if the
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function requires offset terms, there is no
mechanism to pass those along, which will result in an error.</li>
</ul>
<p>Below is what happens if we attempt to fit 5 bootstrap resamples of
the <code>us_deaths</code> data set without offsetreg.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resamples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/bootstraps.html" class="external-link">bootstraps</a></span><span class="op">(</span><span class="va">us_deaths</span>, times <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_glmnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html" class="external-link">poisson_reg</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">1E-5</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"glmnet"</span>, offset <span class="op">=</span> <span class="va">us_deaths</span><span class="op">$</span><span class="va">log_pop</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_recipe.html" class="external-link">add_recipe</a></span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model</a></span><span class="op">(</span><span class="va">mod_glmnet</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tune.tidymodels.org/reference/fit_resamples.html" class="external-link">fit_resamples</a></span><span class="op">(</span><span class="va">resamples</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html" class="external-link">collect_metrics</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; → <span style="color: #BB0000; font-weight: bold;">A</span> | <span style="color: #BB0000;">error</span>:   No newoffset provided for prediction, yet offset used in fit of glmnet</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BB0000; font-weight: bold;">A</span>: x1</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BB0000; font-weight: bold;">A</span>: x5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Warning: All models failed. Run `show_notes(.Last.tune.result)` for more</span></span>
<span><span class="co">#&gt; information.</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `estimate_tune_results()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> All models failed. Run `show_notes(.Last.tune.result)` for more information.</span></span></code></pre></div>
<p>All models failed to fit, and we receive a specific error message
about no offsets being available for predictions.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tune.tidymodels.org/reference/show_notes.html" class="external-link">show_notes</a></span><span class="op">(</span><span class="va">.Last.tune.result</span><span class="op">)</span></span>
<span><span class="co">#&gt; unique notes:</span></span>
<span><span class="co">#&gt; ──────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; No newoffset provided for prediction, yet offset used in fit of glmnet</span></span></code></pre></div>
<p>With offsetreg, this code performs as expected. offsetreg works
because behind the scenes it ensures that offset terms are attached to
the data at all times, which enables resampling and predictions to
function without error.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_recipe.html" class="external-link">add_recipe</a></span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model</a></span><span class="op">(</span><span class="va">mod_offset</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tune.tidymodels.org/reference/fit_resamples.html" class="external-link">fit_resamples</a></span><span class="op">(</span><span class="va">resamples</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html" class="external-link">collect_metrics</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">#&gt;   .metric .estimator      mean     n    std_err .config             </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rmse    standard   <span style="text-decoration: underline;">22</span>400.        5 <span style="text-decoration: underline;">1</span>090.      Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rsq     standard       0.980     5    0.002<span style="text-decoration: underline;">16</span> Preprocessor1_Model1</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matt Heaphy.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
